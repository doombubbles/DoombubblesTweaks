// Adapted and simplified from Smart War Magic by Siael

new entry "WarMagic"
type "PassiveData"
using "WarMagic"
data "Conditions" ""
data "StatsFunctors" "IF(IsCantrip() and HasUseCosts('ActionPoint',true) and not HasStatus('WM_GLOBAL_CHECK', context.Source) and HasActionResource('BonusActionPoint',1,0,false)):ApplyStatus(SELF,WM_BONUS_ATTACK,100,1);IF(IsAttack() and not IsOffHandAttack() and not IsCantrip() and HasUseCosts('ActionPoint',true) and not HasStatus('WM_GLOBAL_CHECK', context.Source) and HasActionResource('BonusActionPoint',1,0,false)):ApplyStatus(SELF,WM_BONUS_CANTRIP,100,1);"

// Next attack costs a Bonus Action, leads to extra attack(s)
new entry "WM_BONUS_ATTACK"
type "StatusData"
data "StatusType" "BOOST"
data "DisplayName" "h9ca8e06egf82bg41e9gba15gcd2265743c20;1"
data "Description" "h4065dd28g293eg4705g9dafg7b16b410e232;1"
data "Icon" "PassiveFeature_ExtraAttack"
data "StackId" "EXTRA_ATTACK"
data "StackPriority" "70"
data "Boosts" "UnlockSpellVariant(ExtraAttackCheck() & ~IsCantrip(),ModifyUseCosts(Replace,BonusActionPoint,1,0,ActionPoint),ModifyIconGlow(),ModifyTooltipDescription())"
data "RemoveConditions" "(ExtraAttackSpellCheck() and not IsOffHandAttack()) or not HasActionResource('BonusActionPoint', 1, 0, false, false)"
data "RemoveEvents" "OnSpellCast"
data "OnRemoveFunctors" "IF(HasPassive('ThirstingBlade_Blade') and HasPactWeapon()):ApplyStatus(SELF,EXTRA_ATTACK_THIRSTING_BLADE_Q,100,1);IF(HasPassive('ExtraAttack_3')):ApplyStatus(SELF,EXTRA_ATTACK_3_Q,100,1);IF(HasPassive('ExtraAttack_2') and not HasPassive('ExtraAttack_3')):ApplyStatus(SELF,EXTRA_ATTACK_2_Q,100,1);IF(HasPassive('ExtraAttack') and not HasPassive('ExtraAttack_3')):ApplyStatus(SELF,EXTRA_ATTACK_Q,100,1)"
data "OnApplyFunctors" "ApplyStatus(WM_GLOBAL_CHECK,100,1)"
data "StatusPropertyFlags" "DisableCombatlog;DisableOverhead"

// Next cantrip costs a Bonus Action
new entry "WM_BONUS_CANTRIP"
type "StatusData"
data "StatusType" "BOOST"
data "DisplayName" "h6829a9d1ga919g44afga73fg49cc1378ad95;1"
data "Description" "h26b30cbag7290g402ag8c7cg0510cd5ac2f2;1"
data "Icon" "PassiveFeature_WarMagic"
data "StackID" "WM_CANTRIP"
data "Boosts" "UnlockSpellVariant(QuickenedCantripCheck(),ModifyUseCosts(Replace,BonusActionPoint,1,0,ActionPoint),ModifyIconGlow(),ModifyTooltipDescription())"
data "RemoveConditions" "IsCantrip() or not HasActionResource('BonusActionPoint', 1, 0, false, false)"
data "RemoveEvents" "OnSpellCast"
data "OnApplyFunctors" "ApplyStatus(WM_GLOBAL_CHECK,100,1)"
data "StatusPropertyFlags" "DisableCombatlog;DisableOverhead"

// Status to limit one use per turn
new entry "WM_GLOBAL_CHECK"
type "StatusData"
data "StatusType" "BOOST"
data "DisplayName" "h50e3d7edg5f31g4a30gb3ecga03a73857828;2"
data "Description" "h95efd706g1dc1g4121gba20g824eb3813025;1"
data "Icon" "PassiveFeature_WarMagic"
data "StatusPropertyFlags" "DisableCombatlog;DisableOverhead;DisablePortraitIndicator"